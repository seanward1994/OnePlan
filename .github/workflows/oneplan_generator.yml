name: OnePlan — Project Generator

on:
  workflow_dispatch:

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Android project files
        run: |
          set -euo pipefail

          mkdir -p app/src/main/java/com/oneplan/app/ui/screens
          mkdir -p app/src/main/java/com/oneplan/app/ui/theme
          mkdir -p app/src/main/java/com/oneplan/app/navigation
          mkdir -p app/src/main/res/values
          mkdir -p .github/workflows
          mkdir -p gradle/wrapper

          # settings.gradle.kts
          cat > settings.gradle.kts <<'EOF'
          pluginManagement { repositories { google(); mavenCentral() } }
          dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories { google(); mavenCentral() }
          }
          rootProject.name = "OnePlanAndroid"
          include(":app")
          EOF

          # root build.gradle.kts
          cat > build.gradle.kts <<'EOF'
          plugins {
            id("com.android.application") version "8.5.2" apply false
            id("org.jetbrains.kotlin.android") version "2.0.20" apply false
          }
          EOF

          # app/build.gradle.kts
          cat > app/build.gradle.kts <<'EOF'
          plugins {
            id("com.android.application")
            id("org.jetbrains.kotlin.android")
          }
          android {
            namespace = "com.oneplan.app"
            compileSdk = 34
            defaultConfig {
              applicationId = "com.oneplan.app"
              minSdk = 24
              targetSdk = 34
              versionCode = 1
              versionName = "0.1.0"
            }
          }
          EOF

          # MainActivity
          cat > app/src/main/java/com/oneplan/app/MainActivity.kt <<'EOF'
          package com.oneplan.app
          import android.os.Bundle
          import androidx.activity.ComponentActivity
          import androidx.activity.compose.setContent
          import androidx.compose.material3.Text
          import androidx.compose.runtime.Composable
          class MainActivity : ComponentActivity() {
              override fun onCreate(savedInstanceState: Bundle?) {
                  super.onCreate(savedInstanceState)
                  setContent { Greeting("OnePlan") }
              }
          }
          @Composable fun Greeting(name: String) { Text("Hello $name!") }
          EOF

          # AndroidManifest.xml
          mkdir -p app/src/main
          cat > app/src/main/AndroidManifest.xml <<'EOF'
          <manifest xmlns:android="http://schemas.android.com/apk/res/android"
              package="com.oneplan.app">
              <application android:label="OnePlan">
                  <activity android:name=".MainActivity" android:exported="true">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
              </application>
          </manifest>
          EOF

          # Simple theme & colors
          cat > app/src/main/res/values/colors.xml <<'EOF'
          <resources><color name="purple">#6200EE</color></resources>
          EOF
          cat > app/src/main/res/values/themes.xml <<'EOF'
          <resources>
            <style name="Theme.OnePlan" parent="Theme.Material3.DayNight.NoActionBar" />
          </resources>
          EOF

          # CI workflow for builds
          cat > .github/workflows/android-ci.yml <<'EOF'
          name: OnePlanAndroid — CI
          on:
            push:
              branches: [ main ]
            workflow_dispatch:
          jobs:
            build:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - name: Set up JDK 17
                  uses: actions/setup-java@v4
                  with:
                    distribution: 'temurin'
                    java-version: '17'
                    cache: 'gradle'
                - name: Make gradlew executable
                  run: chmod +x ./gradlew || true
                - name: Build debug APK
                  run: ./gradlew assembleDebug || echo "Gradle wrapper not ready yet"
                - name: Upload Debug APKs
                  uses: actions/upload-artifact@v4
                  with:
                    name: oneplan-debug-apks
                    path: '**/build/outputs/apk/debug/*.apk'
          EOF

      - name: Commit & push to bootstrap branch
        run: |
          set -euo pipefail
          git config user.name "oneplan-bot"
          git config user.email "oneplan-bot@users.noreply.github.com"
          git checkout -B bootstrap
          git add -A
          git commit -m "Bootstrap: generate OnePlanAndroid project" || echo "No changes"
          git push -u origin bootstrap

      - name: Open PR into main
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const {owner, repo} = context.repo;
            const head = `${owner}:bootstrap`;
            const prs = await github.rest.pulls.list({ owner, repo, head, state: "open" });
            if (prs.data.length === 0) {
              await github.rest.pulls.create({
                owner, repo,
                head: "bootstrap",
                base: "main",
                title: "Bootstrap: add OnePlanAndroid project + CI",
                body: "Merge this PR to enable OnePlanAndroid CI and APK builds."
              });
            }

